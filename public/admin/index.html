<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elahe Panel - Admin Dashboard</title>
  <link rel="stylesheet" href="/shared/css/common.css">
  <link rel="stylesheet" href="/admin/css/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="admin-layout" id="app" style="display:none">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">&#11042;</div>
        <span class="sidebar-title">Elahe Panel</span>
        <span class="sidebar-version">v0.0.3</span>
      </div>
      <nav class="sidebar-nav">
        <a class="sidebar-link active" data-page="dashboard" onclick="navigate('dashboard')">
          <span class="sidebar-icon">&#128200;</span>Dashboard
        </a>
        <a class="sidebar-link" data-page="users" onclick="navigate('users')" id="nav-users">
          <span class="sidebar-icon">&#128100;</span>Users
        </a>
        <a class="sidebar-link" data-page="servers" onclick="navigate('servers')">
          <span class="sidebar-icon">&#128421;</span>Servers
        </a>
        <a class="sidebar-link" data-page="tunnels" onclick="navigate('tunnels')">
          <span class="sidebar-icon">&#128268;</span>Tunnels
        </a>
        <a class="sidebar-link" data-page="autopilot" onclick="navigate('autopilot')">
          <span class="sidebar-icon">&#9889;</span>Autopilot
        </a>
        <a class="sidebar-link" data-page="domains" onclick="navigate('domains')">
          <span class="sidebar-icon">&#127760;</span>Domains
        </a>
        <a class="sidebar-link" data-page="external-panels" onclick="navigate('external-panels')">
          <span class="sidebar-icon">&#128279;</span>External Panels
        </a>
        <a class="sidebar-link" data-page="importexport" onclick="navigate('importexport')" id="nav-importexport">
          <span class="sidebar-icon">&#128229;</span>Import/Export
        </a>
        <a class="sidebar-link" data-page="settings" onclick="navigate('settings')">
          <span class="sidebar-icon">&#9881;</span>Settings
        </a>
      </nav>
      <div class="sidebar-footer">
        <div style="padding:4px 12px;font-size:11px;color:#94a3b8;margin-bottom:4px" id="mode-badge"></div>
        <button class="btn btn-sm btn-danger" onclick="logout()" style="width:100%">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="topbar">
        <button class="topbar-menu" onclick="toggleSidebar()">&#9776;</button>
        <h2 id="page-title">Dashboard</h2>
        <div class="topbar-right">
          <span id="admin-name">Admin</span>
        </div>
      </header>

      <!-- Dashboard Page -->
      <div class="page" id="page-dashboard">
        <div class="grid grid-4 gap-3 mb-3">
          <div class="stat-card"><div class="stat-icon stat-blue">&#128100;</div><div><div class="stat-value" id="stat-users-total">-</div><div class="stat-label">Total Users</div></div></div>
          <div class="stat-card"><div class="stat-icon stat-green">&#9889;</div><div><div class="stat-value" id="stat-users-active">-</div><div class="stat-label">Active Users</div></div></div>
          <div class="stat-card"><div class="stat-icon stat-purple">&#128421;</div><div><div class="stat-value" id="stat-servers-total">-</div><div class="stat-label">Servers</div></div></div>
          <div class="stat-card"><div class="stat-icon stat-orange">&#128268;</div><div><div class="stat-value" id="stat-tunnels-active">-</div><div class="stat-label">Active Tunnels</div></div></div>
        </div>
        <div class="grid grid-2 gap-3">
          <div class="card">
            <div class="card-header">User Statistics</div>
            <div id="user-stats-detail">Loading...</div>
          </div>
          <div class="card">
            <div class="card-header">Server Status</div>
            <div id="server-stats-detail">Loading...</div>
          </div>
        </div>
        <div class="grid grid-2 gap-3 mt-3">
          <div class="card">
            <div class="card-header">Autopilot Status</div>
            <div id="autopilot-dashboard-detail">Loading...</div>
          </div>
          <div class="card">
            <div class="card-header">Panel Mode</div>
            <div id="panel-mode-detail">Loading...</div>
          </div>
        </div>

        <!-- System Resources Section -->
        <div class="card mt-3">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
            System Resources
            <button class="btn btn-sm btn-outline" onclick="loadSystemResources()">&#8635; Refresh</button>
          </div>
          <div id="system-resources">
            <div class="grid grid-4 gap-2 mt-2">
              <div class="stat-card"><div class="stat-icon" style="background:#dbeafe;color:#2563eb">&#128187;</div><div><div class="stat-value" id="res-cpu">-</div><div class="stat-label">CPU Usage</div></div></div>
              <div class="stat-card"><div class="stat-icon" style="background:#fce7f3;color:#db2777">&#128202;</div><div><div class="stat-value" id="res-ram">-</div><div class="stat-label">RAM Usage</div></div></div>
              <div class="stat-card"><div class="stat-icon" style="background:#d1fae5;color:#059669">&#128190;</div><div><div class="stat-value" id="res-disk">-</div><div class="stat-label">Disk Usage</div></div></div>
              <div class="stat-card"><div class="stat-icon" style="background:#fef3c7;color:#d97706">&#9201;</div><div><div class="stat-value" id="res-uptime">-</div><div class="stat-label">Uptime</div></div></div>
            </div>
            <div class="grid grid-2 gap-2 mt-2">
              <div id="res-detail-left" style="font-size:13px;color:#64748b;line-height:2"></div>
              <div id="res-detail-right" style="font-size:13px;color:#64748b;line-height:2"></div>
            </div>
          </div>
        </div>

        <!-- Bandwidth Summary -->
        <div class="grid grid-3 gap-3 mt-3">
          <div class="stat-card"><div class="stat-icon" style="background:#ede9fe;color:#7c3aed">&#128228;</div><div><div class="stat-value" id="bw-today">-</div><div class="stat-label">Today Bandwidth</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#fce7f3;color:#be185d">&#128229;</div><div><div class="stat-value" id="bw-total">-</div><div class="stat-label">Total Bandwidth</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#dbeafe;color:#1d4ed8">&#128279;</div><div><div class="stat-value" id="bw-connections">-</div><div class="stat-label">Active Connections</div></div></div>
        </div>
      </div>

      <!-- Users Page -->
      <div class="page" id="page-users" style="display:none">
        <div class="flex gap-2 mb-3" style="justify-content:space-between;flex-wrap:wrap">
          <div class="flex gap-2">
            <input type="text" class="form-control" id="user-search" placeholder="Search users..." style="width:250px" oninput="debounceSearchUsers()">
            <select class="form-control" id="user-filter-status" style="width:150px" onchange="loadUsers()">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="expired">Expired</option>
              <option value="limited">Limited</option>
              <option value="disabled">Disabled</option>
            </select>
          </div>
          <div class="flex gap-2" id="user-actions-iran">
            <button class="btn btn-primary" onclick="showCreateUserModal()">+ Create User</button>
            <button class="btn btn-secondary" onclick="showAutoCreateModal()">Auto Create</button>
          </div>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Username</th><th>UUID</th><th>Plan</th><th>Status</th><th>Traffic</th><th>Expires</th><th>Actions</th></tr>
              </thead>
              <tbody id="users-table-body"><tr><td colspan="7">Loading...</td></tr></tbody>
            </table>
          </div>
          <div class="pagination mt-2" id="users-pagination"></div>
        </div>
      </div>

      <!-- Servers Page -->
      <div class="page" id="page-servers" style="display:none">
        <div class="flex gap-2 mb-3" style="justify-content:flex-end">
          <button class="btn btn-primary" onclick="showAddServerModal()">+ Add Server</button>
        </div>
        <div class="grid grid-2 gap-3" id="servers-grid">Loading...</div>
      </div>

      <!-- Tunnels Page -->
      <div class="page" id="page-tunnels" style="display:none">
        <div class="flex gap-2 mb-3" style="justify-content:space-between">
          <h3>Tunnel Management</h3>
          <div class="flex gap-2">
            <button class="btn btn-primary" onclick="showAddTunnelModal()">+ Add Tunnel</button>
            <button class="btn btn-secondary" onclick="runMonitoring()">&#9881; Run Monitor</button>
          </div>
        </div>
        <div class="card mb-3">
          <div class="card-header">Port Allocation Rules</div>
          <div id="port-rules-info" style="font-size:13px;color:#64748b;line-height:1.8">
            <div><strong>Port 443:</strong> Best tunnel auto-selected (SSH / FRP / GOST / Chisel) - Current: <span id="port443-engine" class="badge badge-info">-</span></div>
            <div><strong>Port 8443:</strong> TrustTunnel (HTTP/3) - <span class="badge badge-success">Always Active</span></div>
            <div><strong>Ports 110, 510:</strong> OpenVPN - <span class="badge badge-success">Always Active</span></div>
            <div><strong>Ports 1414, 53133:</strong> WireGuard - <span class="badge badge-success">Always Active</span></div>
          </div>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead><tr><th>Protocol</th><th>Transport</th><th>Port</th><th>Status</th><th>Score</th><th>Latency</th><th>Primary</th><th>Actions</th></tr></thead>
              <tbody id="tunnels-table-body"><tr><td colspan="8">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Autopilot Page -->
      <div class="page" id="page-autopilot" style="display:none">
        <div class="flex gap-2 mb-3" style="justify-content:space-between;flex-wrap:wrap">
          <h3>Autopilot Tunnel Management</h3>
          <div class="flex gap-2">
            <button class="btn btn-primary" onclick="runAutopilotMonitor()">&#9889; Run Autopilot Cycle</button>
          </div>
        </div>

        <div class="grid grid-3 gap-3 mb-3">
          <div class="stat-card"><div class="stat-icon stat-blue">&#128268;</div><div><div class="stat-value" id="ap-primary443">-</div><div class="stat-label">Primary on Port 443</div></div></div>
          <div class="stat-card"><div class="stat-icon stat-green">&#9889;</div><div><div class="stat-value" id="ap-switch-count">-</div><div class="stat-label">Auto Switches</div></div></div>
          <div class="stat-card"><div class="stat-icon stat-orange">&#128336;</div><div><div class="stat-value" id="ap-last-cycle">-</div><div class="stat-label">Last Cycle</div></div></div>
        </div>

        <div class="card mb-3">
          <div class="card-header">Port 443 - Tunnel Candidates</div>
          <p style="color:#64748b;font-size:13px;margin-bottom:12px">These tunnels compete for port 443. Autopilot selects the best one every 10 minutes.</p>
          <div id="autopilot-candidates">Loading...</div>
        </div>

        <div class="card mb-3">
          <div class="card-header">Always-On Services</div>
          <p style="color:#64748b;font-size:13px;margin-bottom:12px">These services run on dedicated ports and are always active.</p>
          <div id="autopilot-always-on">Loading...</div>
        </div>

        <div class="card mb-3">
          <div class="card-header">Manual Override</div>
          <p style="color:#64748b;font-size:13px;margin-bottom:12px">Manually select the primary tunnel for port 443.</p>
          <div class="flex gap-2">
            <select class="form-control" id="manual-primary-select" style="width:200px">
              <option value="ssh">SSH</option>
              <option value="frp">FRP (TLS)</option>
              <option value="gost" selected>GOST (TLS/QUIC)</option>
              <option value="chisel">Chisel (TLS)</option>
            </select>
            <button class="btn btn-primary" onclick="setManualPrimary()">Set Primary</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Tunnel Engines</div>
          <div id="tunnel-engines-list">Loading...</div>
        </div>
      </div>

      <!-- Domains Page -->
      <div class="page" id="page-domains" style="display:none">
        <div class="flex gap-2 mb-3" style="justify-content:space-between;flex-wrap:wrap">
          <h3>Domain Management</h3>
          <div class="flex gap-2">
            <button class="btn btn-primary" onclick="showAddDomainModal()">+ Add Domain</button>
            <button class="btn btn-secondary" onclick="showGenerateSubdomainsModal()">Auto Generate Subdomains</button>
          </div>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead><tr><th>Domain</th><th>Type</th><th>Purpose</th><th>SSL</th><th>Iran Access</th><th>Last Check</th><th>Actions</th></tr></thead>
              <tbody id="domains-table-body"><tr><td colspan="7">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- External Panels Page -->
      <div class="page" id="page-external-panels" style="display:none">
        <div class="flex gap-2 mb-3" style="justify-content:space-between;flex-wrap:wrap">
          <h3>External Panels (Marzban / 3x-ui)</h3>
          <button class="btn btn-primary" onclick="showAddExternalPanelModal()">+ Add Panel</button>
        </div>
        <div class="grid grid-2 gap-3" id="external-panels-grid">Loading...</div>
      </div>

      <!-- Import/Export Page -->
      <div class="page" id="page-importexport" style="display:none">
        <div class="grid grid-2 gap-3">
          <div class="card">
            <div class="card-header">Export</div>
            <div class="mt-2">
              <p style="color:#64748b;font-size:13px;margin-bottom:12px">Download users, settings, or full backup as JSON files.</p>
              <div class="flex gap-2" style="flex-direction:column">
                <div class="flex gap-2">
                  <select class="form-control" id="export-format" style="width:200px">
                    <option value="elahe">Elahe Format</option>
                    <option value="marzban">Marzban Format</option>
                    <option value="3xui">3x-ui Format</option>
                  </select>
                  <button class="btn btn-primary" onclick="exportUsers()">Export Users</button>
                </div>
                <button class="btn btn-secondary" onclick="exportSettings()">Export Settings</button>
                <button class="btn btn-outline" onclick="exportFull()">Full Backup</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">Import</div>
            <div class="mt-2">
              <p style="color:#64748b;font-size:13px;margin-bottom:12px">Import users or settings from JSON files. Supports Elahe, Marzban, and 3x-ui formats.</p>
              <div class="flex gap-2" style="flex-direction:column">
                <div class="form-group">
                  <label>Select JSON file</label>
                  <input type="file" class="form-control" id="import-file" accept=".json" style="padding:8px">
                </div>
                <div class="flex gap-2">
                  <button class="btn btn-primary" onclick="importUsers()">Import Users</button>
                  <button class="btn btn-secondary" onclick="importSettings()">Import Settings</button>
                  <button class="btn btn-outline" onclick="importFull()">Full Restore</button>
                </div>
              </div>
              <div id="import-result" class="mt-2" style="display:none"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Page -->
      <div class="page" id="page-settings" style="display:none">
        <div class="card">
          <div class="card-header">Site Configuration</div>
          <form id="settings-form" onsubmit="saveSettings(event)">
            <div id="settings-sections"></div>
            <button type="submit" class="btn btn-primary mt-3">Save Settings</button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- Create User Modal -->
  <div class="modal-overlay" id="createUserModal">
    <div class="modal">
      <div class="modal-title">Create User <button class="modal-close-btn" onclick="closeModal('createUserModal')">&times;</button></div>
      <div id="create-user-error" class="alert alert-error" style="display:none"></div>
      <form onsubmit="createUser(event)">
        <div class="form-group"><label>Username *</label><input class="form-control" id="cu-username" required></div>
        <div class="form-group"><label>Password (auto if empty)</label><input class="form-control" id="cu-password"></div>
        <div class="form-group"><label>Email</label><input type="email" class="form-control" id="cu-email"></div>
        <div class="form-group"><label>Plan</label><select class="form-control" id="cu-plan"><option value="bronze">Bronze</option><option value="silver">Silver</option><option value="gold">Gold</option></select></div>
        <div class="form-group"><label>Traffic Limit (GB)</label><input type="number" class="form-control" id="cu-traffic" value="50"></div>
        <div class="form-group"><label>Expiry Days</label><input type="number" class="form-control" id="cu-expiry" value="30"></div>
        <div class="form-group"><label>Max Connections</label><input type="number" class="form-control" id="cu-maxconn" value="2"></div>
        <div class="form-group"><label>Note</label><textarea class="form-control" id="cu-note" rows="2"></textarea></div>
        <div class="alert alert-info" style="font-size:12px;margin-bottom:12px">
          <strong>TrustTunnel:</strong> Always active on port 8443. Users can connect via HTTP/3 using Hiddify/Streisand apps.<br>
          <strong>OpenVPN &amp; WireGuard:</strong> Always active on dedicated ports. Configs in user subscription page.
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%">Create User</button>
      </form>
    </div>
  </div>

  <!-- Add Server Modal -->
  <div class="modal-overlay" id="addServerModal">
    <div class="modal">
      <div class="modal-title">Add Server <button class="modal-close-btn" onclick="closeModal('addServerModal')">&times;</button></div>
      <form onsubmit="addServer(event)">
        <div class="form-group"><label>Name *</label><input class="form-control" id="as-name" required></div>
        <div class="form-group"><label>Type *</label><select class="form-control" id="as-type"><option value="iran">Iran (Edge)</option><option value="foreign">Foreign (Upstream)</option></select></div>
        <div class="form-group"><label>IP Address *</label><input class="form-control" id="as-ip" required></div>
        <div class="form-group"><label>Port</label><input type="number" class="form-control" id="as-port" value="3000"></div>
        <div class="form-group"><label>Core Engine</label><select class="form-control" id="as-core"><option value="xray">Xray</option><option value="singbox">Sing-box</option></select></div>
        <div class="form-group"><label>Location</label><input class="form-control" id="as-location"></div>
        <div class="form-group"><label>Max Users</label><input type="number" class="form-control" id="as-maxusers" value="100"></div>
        <button type="submit" class="btn btn-primary" style="width:100%">Add Server</button>
      </form>
    </div>
  </div>

  <!-- User Info Modal -->
  <div class="modal-overlay" id="userInfoModal">
    <div class="modal" style="max-width:600px">
      <div class="modal-title">User Details <button class="modal-close-btn" onclick="closeModal('userInfoModal')">&times;</button></div>
      <div id="user-info-content">Loading...</div>
    </div>
  </div>

  <!-- Add Domain Modal -->
  <div class="modal-overlay" id="addDomainModal">
    <div class="modal">
      <div class="modal-title">Add Domain <button class="modal-close-btn" onclick="closeModal('addDomainModal')">&times;</button></div>
      <form onsubmit="addDomain(event)">
        <div class="form-group"><label>Domain *</label><input class="form-control" id="ad-domain" required placeholder="example.com"></div>
        <div class="form-group"><label>Server (optional)</label><select class="form-control" id="ad-server"><option value="">None</option></select></div>
        <button type="submit" class="btn btn-primary" style="width:100%">Add Domain</button>
      </form>
    </div>
  </div>

  <!-- Generate Subdomains Modal -->
  <div class="modal-overlay" id="generateSubdomainsModal">
    <div class="modal">
      <div class="modal-title">Generate Subdomains <button class="modal-close-btn" onclick="closeModal('generateSubdomainsModal')">&times;</button></div>
      <form onsubmit="generateSubdomains(event)">
        <div class="form-group"><label>Parent Domain *</label><input class="form-control" id="gs-domain" required placeholder="example.com"></div>
        <div class="form-group"><label>Server (optional)</label><select class="form-control" id="gs-server"><option value="">None</option></select></div>
        <p style="font-size:12px;color:#64748b;margin-bottom:12px">This will automatically generate 10 non-suspicious subdomains (cdn, api, mail, cloud, portal, app, data, auth, static, media) for the specified domain.</p>
        <button type="submit" class="btn btn-primary" style="width:100%">Generate 10 Subdomains</button>
      </form>
    </div>
  </div>

  <!-- Add External Panel Modal -->
  <div class="modal-overlay" id="addExternalPanelModal">
    <div class="modal">
      <div class="modal-title">Add External Panel <button class="modal-close-btn" onclick="closeModal('addExternalPanelModal')">&times;</button></div>
      <form onsubmit="addExternalPanel(event)">
        <div class="form-group"><label>Name *</label><input class="form-control" id="ep-name" required placeholder="My Marzban Panel"></div>
        <div class="form-group"><label>Type *</label><select class="form-control" id="ep-type"><option value="marzban">Marzban</option><option value="3xui">3x-ui</option></select></div>
        <div class="form-group"><label>URL *</label><input class="form-control" id="ep-url" required placeholder="https://panel.example.com:8080"></div>
        <div class="form-group"><label>Username</label><input class="form-control" id="ep-username"></div>
        <div class="form-group"><label>Password</label><input type="password" class="form-control" id="ep-password"></div>
        <button type="submit" class="btn btn-primary" style="width:100%">Add Panel</button>
      </form>
    </div>
  </div>

  <script src="/admin/js/admin.js"></script>
</body>
</html>
